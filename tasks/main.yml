---
- name: Verify checksum is defined
  ansible.builtin.assert:
    that:
      - steamengine_build_checksum is defined
      - steamengine_ignore_checksum or checksum.strip() != ''
    fail_msg: "The checksum '{{ steamengine_build_checksum }}' isn't defined."
  tags: always

- name: Verify project type
  ansible.builtin.assert:
    that:
      - "steamengine_project_type is defined"
      - "steamengine_project_type in steamengine_project_types"
  tags: always
  when: steamengine_project_name not in steamengine_projects_to_delete

- name: "Include variables for {{ steamengine_project_type }}"
  ansible.builtin.include_vars:
    file: "vars/{{ steamengine_project_type }}.yml"
  tags: always
  when: steamengine_project_name not in steamengine_projects_to_delete

- include_tasks:
    file: "{{ steamengine_project_type }}/asserts.yml"
    apply:
      tags:
        - steamengine_deploy
  tags: always
  when: steamengine_project_name not in steamengine_projects_to_delete

- include_tasks:
    file: common/install_deps.yml
    apply:
      tags:
        - steamengine_dependencies
  tags: always
  when: steamengine_project_name not in steamengine_projects_to_delete

- include_tasks:
    file: common/user.yml
    apply:
      tags:
        - steamengine_user
  tags: always
  when: steamengine_project_name not in steamengine_projects_to_delete

- include_tasks:
    file: common/structure.yml
    apply:
      tags:
        - steamengine_structure
  tags: always
  when: steamengine_project_name not in steamengine_projects_to_delete

- include_tasks:
    file: common/runtime.yml
    apply:
      tags:
        - steamengine_runtime
  tags: always
  when: steamengine_project_name not in steamengine_projects_to_delete

- include_tasks:
    file: "{{ steamengine_project_type }}/runtime.yml"
    apply:
      tags:
        - steamengine_runtime
  tags: always
  when: steamengine_project_name not in steamengine_projects_to_delete

- name: "Initialize var new_build_to_deploy"
  ansible.builtin.set_fact:
    new_build_to_deploy: false
  tags: always

- include_tasks:
    file: "{{ steamengine_project_type }}/deploy.yml"
    apply:
      tags:
        - steamengine_deploy
  when:
    - steamengine_build_url is defined and steamengine_build_url
    - steamengine_project_name not in steamengine_projects_to_delete
  tags: always

- include_tasks:
    file: common/cron.yml
    apply:
      tags:
        - steamengine_cron
  tags: always

- include_tasks:
    file: common/post_deploy.yml
    apply:
      tags:
        - steamengine_deploy
  tags: always

- include_tasks:
    file: common/delete_project.yml
    apply:
      tags:
        - steamengine_delete_project
  tags: always
  when: steamengine_project_name in steamengine_projects_to_delete
